{% extends 'base.html' %}
{% load pac_tags %}
{% load humanize %}

{% block title %}Reportes y Analisis{% endblock %}
{% block page_title %}Reportes y Analisis - Vigencia {{ vigencia }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h5 class="fw-bold text-dark mb-1">Reportes y Analisis</h5>
        <small class="text-muted">Consolidado presupuestal - Vigencia {{ vigencia }}</small>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <form method="get" class="d-flex gap-2 align-items-center">
            <select name="vigencia" class="form-select form-select-sm" style="width:100px" onchange="this.form.submit()">
                <option value="2025" {% if vigencia == 2025 %}selected{% endif %}>2025</option>
                <option value="2026" {% if vigencia == 2026 %}selected{% endif %}>2026</option>
                <option value="2027" {% if vigencia == 2027 %}selected{% endif %}>2027</option>
            </select>
        </form>
        <a href="{% url 'exportar_reporte_fuentes' %}?vigencia={{ vigencia }}" class="btn btn-success btn-sm">
            <i class="fas fa-file-excel me-1"></i>Exportar Reporte Fuentes
        </a>
        <button onclick="window.print()" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-print me-1"></i>Imprimir
        </button>
    </div>
</div>

<!-- Reporte por Fuentes -->
<div class="card-custom mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #1565c0, #1976d2)">
        <span><i class="fas fa-building-columns me-2"></i>Reporte por Fuentes de Financiacion (Ingresos vs Gastos/Compromisos)</span>
    </div>
    <div class="table-responsive">
        <table class="table table-pac table-hover table-striped mb-0">
            <thead>
                <tr>
                    <th rowspan="2" style="vertical-align:middle">Fuente</th>
                    <th colspan="2" class="text-center" style="background:#fff3e0; border-bottom:0">AIM Definitiva</th>
                    <th colspan="2" class="text-center" style="background:#fff9c4; border-bottom:0">Programado</th>
                    <th colspan="2" class="text-center" style="background:#e3f2fd; border-bottom:0">Compromisos</th>
                    <th colspan="2" class="text-center" style="background:#f3e5f5; border-bottom:0">Pagos</th>
                    <th colspan="3" class="text-center" style="background:#e8f5e9; border-bottom:0">% Ejecucion</th>
                </tr>
                <tr>
                    <th class="text-end" style="font-size:0.65rem; background:#fff3e0">Ingresos</th>
                    <th class="text-end" style="font-size:0.65rem; background:#fff3e0">Gastos</th>
                    <th class="text-end" style="font-size:0.65rem; background:#fff9c4">Ingresos</th>
                    <th class="text-end" style="font-size:0.65rem; background:#fff9c4">Gastos</th>
                    <th class="text-end" style="font-size:0.65rem; background:#e3f2fd">Recaudo</th>
                    <th class="text-end" style="font-size:0.65rem; background:#e3f2fd">Gastos</th>
                    <th class="text-end" style="font-size:0.65rem; background:#f3e5f5">Recaudo</th>
                    <th class="text-end" style="font-size:0.65rem; background:#f3e5f5">Gastos</th>
                    <th class="text-center" style="font-size:0.65rem; background:#e8f5e9">Ing.</th>
                    <th class="text-center" style="font-size:0.65rem; background:#e8f5e9">Gas(C)</th>
                    <th class="text-center" style="font-size:0.65rem; background:#e8f5e9">Gas(P)</th>
                </tr>
            </thead>
            <tbody>
                {% for f in reporte_fuentes %}
                <tr>
                    <td class="fw-semibold">{{ f.fuente|truncatewords:3 }}</td>
                    <td class="text-end" style="background:#fff3e0">{{ f.aim_ingresos|formato_moneda }}</td>
                    <td class="text-end" style="background:#fff3e0">{{ f.aim_gastos|formato_moneda }}</td>
                    <td class="text-end" style="background:#fff9c4">{{ f.prog_ingresos|formato_moneda }}</td>
                    <td class="text-end" style="background:#fff9c4">{{ f.prog_gastos|formato_moneda }}</td>
                    <td class="text-end" style="background:#e3f2fd">{{ f.comp_ingresos|formato_moneda }}</td>
                    <td class="text-end" style="background:#e3f2fd">{{ f.comp_gastos|formato_moneda }}</td>
                    <td class="text-end" style="background:#f3e5f5">{{ f.pago_ingresos|formato_moneda }}</td>
                    <td class="text-end" style="background:#f3e5f5">{{ f.pago_gastos|formato_moneda }}</td>
                    <td class="text-center" style="background:#e8f5e9">
                        <span class="badge-pct {{ f.pct_ing|color_porcentaje }}">{{ f.pct_ing|floatformat:1 }}%</span>
                    </td>
                    <td class="text-center" style="background:#e8f5e9">
                        <span class="badge-pct {{ f.pct_gas_comp|color_porcentaje }}">{{ f.pct_gas_comp|floatformat:1 }}%</span>
                    </td>
                    <td class="text-center" style="background:#e8f5e9">
                        <span class="badge-pct {{ f.pct_gas_pago|color_porcentaje }}">{{ f.pct_gas_pago|floatformat:1 }}%</span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="12" class="text-center py-4 text-muted">
                        No hay datos para generar el reporte. Cargue informacion primero.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Grafica por fuentes -->
{% if reporte_fuentes %}
<div class="card-custom mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #e91e63, #f06292)">
        <span><i class="fas fa-chart-bar me-2"></i>Comparativo por Fuentes de Financiacion</span>
    </div>
    <div class="p-3">
        <canvas id="chartFuentes" height="120"></canvas>
    </div>
</div>
{% endif %}

<!-- Resumen mensual acumulado -->
<div class="card-custom mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #ff5722, #ff7043)">
        <span><i class="fas fa-calendar-alt me-2"></i>Resumen Mensual Acumulado</span>
    </div>
    <div class="table-responsive">
        <table class="table table-pac table-hover table-striped mb-0">
            <thead>
                <tr>
                    <th rowspan="2" style="vertical-align:middle">Mes</th>
                    <th colspan="5" class="text-center" style="background:#e8f5e9; border-bottom:0">INGRESOS</th>
                    <th colspan="7" class="text-center" style="background:#ffebee; border-bottom:0">GASTOS</th>
                </tr>
                <tr>
                    <th class="text-end" style="font-size:0.65rem; background:#e8f5e9">Prog. Mes</th>
                    <th class="text-end" style="font-size:0.65rem; background:#e8f5e9">Ejec. Mes</th>
                    <th class="text-end" style="font-size:0.65rem; background:#e8f5e9">Acum. Prog.</th>
                    <th class="text-end" style="font-size:0.65rem; background:#e8f5e9">Acum. Ejec.</th>
                    <th class="text-center" style="font-size:0.65rem; background:#e8f5e9">% Mes</th>
                    <th class="text-end" style="font-size:0.65rem; background:#ffebee">Prog. Mes</th>
                    <th class="text-end" style="font-size:0.65rem; background:#ffebee">Comp. Mes</th>
                    <th class="text-end" style="font-size:0.65rem; background:#ffebee">Pagos Mes</th>
                    <th class="text-end" style="font-size:0.65rem; background:#ffebee">Acum. Prog.</th>
                    <th class="text-end" style="font-size:0.65rem; background:#ffebee">Acum. Comp.</th>
                    <th class="text-center" style="font-size:0.65rem; background:#ffebee">% Comp.</th>
                    <th class="text-center" style="font-size:0.65rem; background:#ffebee">% Pagos</th>
                </tr>
            </thead>
            <tbody>
                {% for r in resumen_mensual %}
                <tr>
                    <td class="fw-semibold">{{ r.mes }}</td>
                    <td class="text-end" style="background:#f1f8e9">{{ r.prog_ing|formato_moneda }}</td>
                    <td class="text-end" style="background:#f1f8e9">{{ r.ejec_ing|formato_moneda }}</td>
                    <td class="text-end" style="background:#f1f8e9">{{ r.acum_prog_ing|formato_moneda }}</td>
                    <td class="text-end" style="background:#f1f8e9">{{ r.acum_ejec_ing|formato_moneda }}</td>
                    <td class="text-center" style="background:#f1f8e9">
                        <span class="badge-pct {{ r.pct_ing|color_porcentaje }}">{{ r.pct_ing }}%</span>
                    </td>
                    <td class="text-end" style="background:#fce4ec">{{ r.prog_gas|formato_moneda }}</td>
                    <td class="text-end" style="background:#fce4ec">{{ r.comp_gas|formato_moneda }}</td>
                    <td class="text-end" style="background:#fce4ec">{{ r.pago_gas|formato_moneda }}</td>
                    <td class="text-end" style="background:#fce4ec">{{ r.acum_prog_gas|formato_moneda }}</td>
                    <td class="text-end" style="background:#fce4ec">{{ r.acum_comp_gas|formato_moneda }}</td>
                    <td class="text-center" style="background:#fce4ec">
                        <span class="badge-pct {{ r.pct_comp|color_porcentaje }}">{{ r.pct_comp }}%</span>
                    </td>
                    <td class="text-center" style="background:#fce4ec">
                        <span class="badge-pct {{ r.pct_pago|color_porcentaje }}">{{ r.pct_pago }}%</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Grafica acumulada -->
{% if resumen_mensual %}
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card-custom">
            <div class="card-header" style="background: linear-gradient(135deg, #4caf50, #66bb6a)">
                <span><i class="fas fa-chart-area me-2"></i>Ingresos Acumulados</span>
            </div>
            <div class="p-3">
                <canvas id="chartIngAcum" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card-custom">
            <div class="card-header" style="background: linear-gradient(135deg, #f44336, #ef5350)">
                <span><i class="fas fa-chart-area me-2"></i>Gastos Acumulados</span>
            </div>
            <div class="p-3">
                <canvas id="chartGasAcum" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Historial de cargas -->
<div class="card-custom">
    <div class="card-header" style="background: linear-gradient(135deg, #607d8b, #78909c)">
        <span><i class="fas fa-history me-2"></i>Historial de Cargas</span>
        <span class="badge bg-white text-dark">{{ cargas|length }} registros</span>
    </div>
    <div class="table-responsive">
        <table class="table table-pac table-hover table-striped mb-0">
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Registros</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                {% for c in cargas %}
                <tr>
                    <td>
                        {% if c.tipo == 'AIM_INICIAL' %}
                        <span class="badge" style="background:#ff9800">AIM Inicial</span>
                        {% elif c.tipo == 'PROGRAMADO' %}
                        <span class="badge" style="background:#ffc107; color:#333">Programado</span>
                        {% elif c.tipo == 'EJECUTADO_COMPROMISO' %}
                        <span class="badge" style="background:#2196f3">Compromisos</span>
                        {% else %}
                        <span class="badge" style="background:#9c27b0">Pagos</span>
                        {% endif %}
                    </td>
                    <td>{{ c.fecha_carga|date:"d/m/Y H:i" }}</td>
                    <td>{{ c.usuario }}</td>
                    <td class="fw-bold">{{ c.registros_cargados }}</td>
                    <td style="font-size:0.8rem">{{ c.observaciones }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-3 text-muted">Sin registros de carga</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if reporte_fuentes %}
<script>
    // Grafica por fuentes
    const labelsF = {{ grafica_fuentes.labels|safe }};
    new Chart(document.getElementById('chartFuentes'), {
        type: 'bar',
        data: {
            labels: labelsF,
            datasets: [{
                label: 'Prog. Ingresos',
                data: {{ grafica_fuentes.prog_ingresos|safe }},
                backgroundColor: 'rgba(76, 175, 80, 0.4)',
                borderColor: '#4caf50',
                borderWidth: 1
            }, {
                label: 'Prog. Gastos',
                data: {{ grafica_fuentes.prog_gastos|safe }},
                backgroundColor: 'rgba(244, 67, 54, 0.4)',
                borderColor: '#f44336',
                borderWidth: 1
            }, {
                label: 'Comp. Gastos',
                data: {{ grafica_fuentes.comp_gastos|safe }},
                backgroundColor: 'rgba(33, 150, 243, 0.4)',
                borderColor: '#2196f3',
                borderWidth: 1
            }, {
                label: 'Pagos Gastos',
                data: {{ grafica_fuentes.pago_gastos|safe }},
                backgroundColor: 'rgba(156, 39, 176, 0.4)',
                borderColor: '#9c27b0',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000000).toFixed(0) + 'M' } } }
        }
    });
</script>
{% endif %}

{% if resumen_mensual %}
<script>
    const mesesR = {{ meses_display|safe }};
    const resumen = [
        {% for r in resumen_mensual %}
        {
            acum_prog_ing: {{ r.acum_prog_ing }}, acum_ejec_ing: {{ r.acum_ejec_ing }},
            acum_prog_gas: {{ r.acum_prog_gas }}, acum_comp_gas: {{ r.acum_comp_gas }},
            acum_pago_gas: {{ r.acum_pago_gas|default:"0" }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Ingresos acumulados
    new Chart(document.getElementById('chartIngAcum'), {
        type: 'line',
        data: {
            labels: mesesR,
            datasets: [{
                label: 'Programado Acum.',
                data: resumen.map(r => r.acum_prog_ing),
                borderColor: '#4caf50', backgroundColor: 'rgba(76,175,80,0.1)',
                fill: true, tension: 0.3
            }, {
                label: 'Ejecutado Acum.',
                data: resumen.map(r => r.acum_ejec_ing),
                borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.1)',
                fill: true, tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000000).toFixed(0) + 'M' } } }
        }
    });

    // Gastos acumulados
    new Chart(document.getElementById('chartGasAcum'), {
        type: 'line',
        data: {
            labels: mesesR,
            datasets: [{
                label: 'Programado Acum.',
                data: resumen.map(r => r.acum_prog_gas),
                borderColor: '#f44336', backgroundColor: 'rgba(244,67,54,0.1)',
                fill: true, tension: 0.3
            }, {
                label: 'Compromisos Acum.',
                data: resumen.map(r => r.acum_comp_gas),
                borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.1)',
                fill: true, tension: 0.3
            }, {
                label: 'Pagos Acum.',
                data: resumen.map(r => r.acum_pago_gas),
                borderColor: '#9c27b0', backgroundColor: 'rgba(156,39,176,0.1)',
                fill: true, tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000000).toFixed(0) + 'M' } } }
        }
    });
</script>
{% endif %}
{% endblock %}
