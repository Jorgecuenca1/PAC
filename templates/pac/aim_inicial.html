{% extends 'base.html' %}
{% load pac_tags %}
{% load humanize %}

{% block title %}AIM Inicial{% endblock %}
{% block page_title %}PAC 2026 - AIM Inicial (Apropiacion Inicial Modificada){% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h5 class="fw-bold text-dark mb-1">AIM Inicial - Vigencia {{ vigencia }}</h5>
        <small class="text-muted">Formato: PAC 2026 AIM INICIAL.xlsx</small>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'descargar_plantilla' 'aim_inicial' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-download me-1"></i>Plantilla Ejemplo
        </a>
        <a href="{% url 'importar_aim_inicial' %}" class="btn btn-warning btn-sm">
            <i class="fas fa-file-import me-1"></i>Importar Excel
        </a>
        <form method="post" action="{% url 'eliminar_datos' 'aim_inicial' %}?vigencia={{ vigencia }}" class="d-inline"
              onsubmit="return confirm('Esta seguro de eliminar todos los datos de AIM Inicial?')">
            {% csrf_token %}
            <button class="btn btn-outline-danger btn-sm"><i class="fas fa-trash me-1"></i>Limpiar</button>
        </form>
    </div>
</div>

<!-- Filtros -->
<div class="card-custom mb-3">
    <div class="p-3">
        <form method="get" class="d-flex gap-3 align-items-center">
            <select name="vigencia" class="form-select form-select-sm" style="width:100px">
                <option value="2025" {% if vigencia == 2025 %}selected{% endif %}>2025</option>
                <option value="2026" {% if vigencia == 2026 %}selected{% endif %}>2026</option>
                <option value="2027" {% if vigencia == 2027 %}selected{% endif %}>2027</option>
            </select>
            <select name="tipo" class="form-select form-select-sm" style="width:140px">
                <option value="">Todos los tipos</option>
                <option value="INGRESO" {% if tipo_filtro == 'INGRESO' %}selected{% endif %}>Ingresos</option>
                <option value="GASTO" {% if tipo_filtro == 'GASTO' %}selected{% endif %}>Gastos</option>
            </select>
            <select name="categoria" class="form-select form-select-sm" style="width:200px">
                <option value="">Todas las categorias</option>
                <option value="INGRESO_CORRIENTE" {% if cat_filtro == 'INGRESO_CORRIENTE' %}selected{% endif %}>Ingresos Corrientes</option>
                <option value="FUNCIONAMIENTO" {% if cat_filtro == 'FUNCIONAMIENTO' %}selected{% endif %}>Funcionamiento</option>
                <option value="INVERSION" {% if cat_filtro == 'INVERSION' %}selected{% endif %}>Inversion</option>
            </select>
            <button class="btn btn-primary btn-sm"><i class="fas fa-filter me-1"></i>Filtrar</button>
        </form>
    </div>
</div>

<!-- Resumen -->
<div class="row g-3 mb-3">
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-label">Total Aprop. Definitiva Ingresos</div>
            <div class="stat-value text-success">{{ total_ingresos|formato_moneda }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-label">Total Aprop. Definitiva Gastos</div>
            <div class="stat-value text-danger">{{ total_gastos|formato_moneda }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-label">Total Registros</div>
            <div class="stat-value text-primary">{{ registros.count }}</div>
        </div>
    </div>
</div>

<!-- Tabla -->
<div class="card-custom">
    <div class="card-header" style="background: linear-gradient(135deg, #ff9800, #ffb74d)">
        <span><i class="fas fa-file-invoice-dollar me-2"></i>AIM Inicial</span>
        <span class="badge bg-white text-dark">{{ registros.count }} registros</span>
    </div>
    <div class="table-responsive" style="max-height:600px; overflow:auto">
        <table class="table table-pac table-hover table-striped mb-0">
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Cat.</th>
                    <th>Codigo Rubro</th>
                    <th>Nombre Rubro</th>
                    <th class="text-end">Aprop. Inicial</th>
                    <th class="text-end">Adiciones</th>
                    <th class="text-end">Reduccion</th>
                    <th class="text-end">Creditos</th>
                    <th class="text-end">Contracred.</th>
                    <th class="text-end">Aprop. Definitiva</th>
                    {% for mes in meses_display %}
                    <th class="text-end">{{ mes|truncatechars:3 }}</th>
                    {% endfor %}
                    <th class="text-end fw-bold">Total PAC</th>
                </tr>
            </thead>
            <tbody>
                {% for reg in registros %}
                <tr {% if reg.es_subtotal %}style="background:#f0f4f8; font-weight:600"{% endif %}>
                    <td>
                        {% if reg.tipo == 'INGRESO' %}
                        <span class="badge bg-success" style="font-size:0.6rem">ING</span>
                        {% else %}
                        <span class="badge bg-danger" style="font-size:0.6rem">GAS</span>
                        {% endif %}
                    </td>
                    <td style="font-size:0.65rem">{{ reg.get_categoria_display|truncatewords:2 }}</td>
                    <td class="fw-semibold" style="font-size:0.7rem">{{ reg.codigo_rubro|truncatechars:35 }}</td>
                    <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis" title="{{ reg.nombre_rubro }}">
                        {{ reg.nombre_rubro|truncatewords:6 }}
                    </td>
                    <td class="text-end">{{ reg.apropiacion_inicial|formato_moneda }}</td>
                    <td class="text-end">{{ reg.adiciones|formato_moneda }}</td>
                    <td class="text-end">{{ reg.reduccion|formato_moneda }}</td>
                    <td class="text-end">{{ reg.creditos|formato_moneda }}</td>
                    <td class="text-end">{{ reg.contracreditos|formato_moneda }}</td>
                    <td class="text-end fw-bold">{{ reg.apropiacion_definitiva|formato_moneda }}</td>
                    <td class="text-end">{{ reg.enero|formato_moneda }}</td>
                    <td class="text-end">{{ reg.febrero|formato_moneda }}</td>
                    <td class="text-end">{{ reg.marzo|formato_moneda }}</td>
                    <td class="text-end">{{ reg.abril|formato_moneda }}</td>
                    <td class="text-end">{{ reg.mayo|formato_moneda }}</td>
                    <td class="text-end">{{ reg.junio|formato_moneda }}</td>
                    <td class="text-end">{{ reg.julio|formato_moneda }}</td>
                    <td class="text-end">{{ reg.agosto|formato_moneda }}</td>
                    <td class="text-end">{{ reg.septiembre|formato_moneda }}</td>
                    <td class="text-end">{{ reg.octubre|formato_moneda }}</td>
                    <td class="text-end">{{ reg.noviembre|formato_moneda }}</td>
                    <td class="text-end">{{ reg.diciembre|formato_moneda }}</td>
                    <td class="text-end fw-bold">{{ reg.total|formato_moneda }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="23" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No hay registros cargados. Importe el archivo <strong>PAC 2026 AIM INICIAL.xlsx</strong>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% if registros %}
            <tfoot>
                <tr class="fw-bold" style="background:#f8fafc">
                    <td colspan="10">TOTALES</td>
                    {% for mes in meses %}
                    <td class="text-end">{{ totales|get_item:mes|formato_moneda }}</td>
                    {% endfor %}
                    <td class="text-end">{{ totales.total|formato_moneda }}</td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>
</div>
{% endblock %}
